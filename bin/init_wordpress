#!/usr/bin/env bash

set -e

if [[ -n "${DEBUG}" ]]; then
    set -x
fi

disclaimer="// Generated by Wodby (add before wp-settings.php include)."
wp_config="${WP_ROOT}/wp-config.php"

su-exec wodby mkdir -p "${WP_ROOT}"

if [[ ! -f "${wp_config}" ]]; then
    su-exec wodby gotpl "/etc/gotpl/wp-config.php.tmpl" > "${wp_config}"
    chown wodby:wodby "${wp_config}"
elif [[ $( grep -ic "wodby.wp-config.php" "${wp_config}" ) -eq 0 ]]; then
    chmod 644 "${wp_config}"
    su-exec wodby sed -i "/wp-settings.php/i \\
${disclaimer} \\
require_once '${CONF_DIR}/wodby.wp-config.php';" "${wp_config}"
fi

wp_content="${WP_ROOT}/wp-content"
su-exec wodby mkdir -p "${wp_content}"

# Update permissions to allow installing/updating themes and plugins from WP admin dashboard.
chown :www-data "${wp_content}"
chmod 775 "${wp_content}"

declare -a writable_wp_content_dirs=(
    "plugins"
    "themes"
    "upgrade"
    "languages"
    "cache"
    "wp-rocket-config"
    "wflogs"
)

for dir in "${writable_wp_content_dirs[@]}"; do
    if [[ -d "${wp_content}/${dir}" ]]; then
        chown -R :www-data "${wp_content}/${dir}"
        chmod -R 775 "${wp_content}/${dir}"
    fi
done

# Symlink public files to files volume
files_link "${wp_content}/uploads"
